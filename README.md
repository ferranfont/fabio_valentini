# Fabio Valentini - NQ Futures Analysis

Advanced trading analysis toolkit for NQ (Nasdaq-100 E-mini) futures featuring Market Profile analysis, d-Shape & p-Shape pattern detection, tick-driven backtesting, and real-time visualization.

## Quick Start

### Run Complete Strategy Pipeline (Recommended)

```bash
cd strategies/strat_OM_4_absortion
python main_start.py
```

This executes the entire workflow:
1. Backtest with tick-driven engine
2. Generate interactive trade visualization
3. Create performance summary and equity charts

### Individual Steps

```bash
# Step 1: Detect Market Profile patterns (run once when data changes)
python strat_absortion/plot_deep.py

# Step 2: Run complete strategy pipeline
cd strategies/strat_OM_4_absortion
python main_start.py
```

---

## Installation

```bash
pip install -r requirements.txt
```

**Key Dependencies:**
- pandas, numpy - Data processing
- plotly - Interactive HTML charts
- matplotlib - Market Profile visualization
- mplcursors - Professional hover tooltips
- streamlit - Real-time streaming app (optional)

---

## Project Overview

### Core Features

**Market Profile Analysis:**
- Rolling 60-second window volume distribution
- d-Shape & p-Shape absorption pattern detection
- 500ms timestamp aggregation for performance
- Interactive visualization with mplcursors tooltips

**Tick-Driven Backtesting:**
- Sequential processing of 448,332 ticks
- Real-time position tracking
- Position limit control (NUM_MAX_OPEN_CONTRACTS)
- Merge-based architecture for accurate timing

**Comprehensive Visualization:**
- Interactive Plotly charts with trade overlays
- Color-coded exits (green=TARGET, red=STOP)
- Dual-panel display (Price + P&L)
- HTML reports with performance metrics

**Automated Workflow:**
- One-command execution (main_start.py)
- Centralized configuration
- Automatic browser opening for reports

---

## Data Sources

The project uses tick-by-tick futures data from the local `data/` folder:

### Primary Data Files

**NQ Futures (Primary):**
- `time_and_sales_nq.csv` - 448,332 tick records (2 days: Oct 9-10, 2025)
  - Columns: Timestamp, Precio, Volumen, Lado, Bid, Ask
  - Format: European (`;` separator, `,` decimal)

- `time_and_sales_nq_30min.csv` - 19,794 records (30-minute subset for testing)

**Signal Files (Generated):**
- `outputs/db_shapes_YYYYMMDD_HHMMSS.csv` - Market Profile pattern detections
  - Generated by `strat_absortion/plot_deep.py`
  - Columns: timestamp, shape, close_price, bid_ask_ratio, num_price_levels, etc.

**Trade Results (Generated):**
- `outputs/tracking_record_absortion_shape_all_day.csv` - Backtest results
  - Generated by strategy backtest engine
  - Columns: entry_time, exit_time, side, profit_dollars, exit_reason, etc.

**Legacy Files (ES Data):**
- `time_and_sales_absorption_NQ.csv` - Legacy absorption detection (from old algorithm)
- `time_and_sales_absorption_ES.csv` - ES processed data
- `es_1min_data_2015_2025.csv` - ES 1-minute bars (2015-2025)
- `es_1D_data.csv` - ES daily data

---

## Core Modules

### 1. Market Profile Pattern Detection

**Script:** `strat_absortion/plot_deep.py`

**Purpose:** Detect d-Shape and p-Shape absorption patterns using rolling Market Profile

**Algorithm:**
1. **500ms timestamp aggregation** (172,783 frames for 2-day dataset)
2. **Rolling Market Profile** (60-second window)
   - Aggregates volume by price level
   - Identifies POC (Point of Control)
   - Calculates volume distribution
3. **Pattern Detection:**
   - **d-Shape** (BID absorption → bullish): 70%+ concentration in lower prices, 10+ levels, 20+ size
   - **p-Shape** (ASK absorption → bearish): 70%+ concentration in upper prices, 10+ levels, 20+ size

**Configuration (Lines 13-25):**
```python
PROFILE_FREQUENCY = 60          # Window size in seconds
CONCENTRATION_THRESHOLD = 0.70  # 70% volume concentration
MIN_LEVELS = 10                 # Minimum price levels
MIN_SIZE = 20                   # Minimum total volume
```

**Performance:**
- Processes 172,783 timestamps in ~3-4 minutes
- Detects ~1,000 patterns (422 d-shapes, 582 p-shapes)

**Output:**
- CSV: `outputs/db_shapes_{timestamp}.csv`
- Interactive matplotlib chart with mplcursors tooltips

**Execution:**
```bash
python strat_absortion/plot_deep.py
```

---

### 2. Trading Strategy Engine

**Script:** `strategies/strat_OM_4_absortion/strat_absortion_shape.py`

**Purpose:** Tick-driven backtest with real-time position tracking

**Strategy Logic:**
- **LONG Entry:** d_shape detected (BID absorption)
- **SHORT Entry:** p_shape detected (ASK absorption)
- **Take Profit:** 4.0 points (configurable)
- **Stop Loss:** 3.0 points (configurable)
- **Max Positions:** 1 (prevents overlapping trades)

**Key Features:**
- Tick-by-tick processing (448,332 ticks)
- Position limit control via NUM_MAX_OPEN_CONTRACTS
- Merge-based architecture (signals + ticks)
- Sequential processing for accurate execution

**Configuration (Lines 35-41):**
```python
SYMBOL = "NQ"
TP_POINTS = 4.0
SL_POINTS = 3.0
POINT_VALUE = 20.0
CONTRACTS = 1
NUM_MAX_OPEN_CONTRACTS = 1  # Prevents overlapping trades
```

**Performance (with NUM_MAX_OPEN_CONTRACTS=1):**
- Trades: 589 (down from 5,367 without position control)
- Win Rate: 50.9%
- Total P&L: $6,660
- Max DD: -$720
- Processing time: ~2-3 minutes

**Output:** `outputs/tracking_record_absortion_shape_all_day.csv`

**Execution:**
```bash
python strategies/strat_OM_4_absortion/strat_absortion_shape.py
```

---

### 3. Main Orchestrator (Recommended)

**Script:** `strategies/strat_OM_4_absortion/main_start.py`

**Purpose:** Automated workflow execution with centralized configuration

**Workflow:**
```
PASO 1: EJECUTANDO BACKTEST
  ├─ Load signals and tick data
  ├─ Run tick-driven backtest
  └─ Generate tracking_record CSV

PASO 2: GENERANDO VISUALIZACIÓN DE TRADES
  ├─ Load trades and base data
  ├─ Create interactive Plotly chart
  └─ Open in browser

PASO 3: GENERANDO RESUMEN ESTADÍSTICO Y GRÁFICOS
  ├─ Calculate performance metrics
  ├─ Generate HTML summary table
  ├─ Create equity/drawdown charts
  └─ Open all reports in browser
```

**Centralized Parameters (Lines 24-56):**
```python
# Files
TNS_FILE = "time_and_sales_nq.csv"
SIGNALS_FILE = "db_shapes_20251024_003251.csv"

# Strategy
TP_POINTS = 4.0
SL_POINTS = 3.0
NUM_MAX_OPEN_CONTRACTS = 1

# Visualization
USE_INDEX_RANGE = False  # Show all trades
```

**Outputs (3 browser tabs):**
1. `charts/trades_visualization_absortion_shape_all_day.html` - Trade chart
2. `charts/summary_report_absortion_shape_all_day.html` - Statistics table
3. `charts/backtest_results_absortion_shape_all_day_*.html` - Equity curves

**Execution:**
```bash
cd strategies/strat_OM_4_absortion
python main_start.py
```

---

### 4. Trade Visualization

**Script:** `strategies/strat_OM_4_absortion/plot_trades_chart.py`

**Purpose:** Interactive Plotly chart with trade overlays

**Visual Elements:**
- **Entry markers:**
  - Triangle-up (green) = LONG
  - Triangle-down (red) = SHORT
- **Exit markers:**
  - Square-open (green) = TARGET exit
  - Square-open (red) = STOP exit
- **Connection lines:** Dotted, color-coded (green=TARGET, red=STOP)
- **Dual panels:** Price chart + P&L cumulative

**Configuration (Lines 57-62):**
```python
USE_INDEX_RANGE = False  # False = show ALL trades
START_INDEX = 0
END_INDEX = 50           # Only used if USE_INDEX_RANGE = True
```

**Modes:**
1. **Full Day** (default): Shows all 589 trades
2. **Index Range**: Filter by trade indices (0-50, etc.)

**Output:** `charts/trades_visualization_absortion_shape_all_day.html`

---

### 5. Performance Summary

**Script:** `strategies/strat_OM_4_absortion/summary.py`

**Purpose:** Comprehensive HTML report with statistics

**Metrics:**
- Win/Loss breakdown
- Profit Factor, Sharpe Ratio
- Max Drawdown, Recovery Factor
- Exit reason analysis (TARGET/STOP)
- Signal breakdown (d_shape vs p_shape)

**Output:** `charts/summary_report_absortion_shape_all_day.html`

---

### 6. Real-Time Streaming (Legacy - Absorption Detection)

**Script:** `plot_real_time_streamlit.py`

**Purpose:** Simulate tick-by-tick replay with old absorption visualization

**Important:** Must use `streamlit run`, NOT `python`. Opens browser at `localhost:8501`.

```bash
streamlit run plot_real_time_streamlit.py
```

**Features:**
- Play/Pause/Reset controls
- Speed: 1-500 records/second
- Buffer size: 50-5000 records
- Absorption markers (triangles with yellow borders)
- Live statistics

**Note:** This uses the legacy absorption detection algorithm, not Market Profile patterns.

---

## Workflow: Complete Strategy Pipeline

### Standard Workflow (Recommended)

```bash
# 1. Detect patterns (run once when data changes)
python strat_absortion/plot_deep.py

# 2. Run complete strategy pipeline
cd strategies/strat_OM_4_absortion
python main_start.py
```

### Manual Step-by-Step

```bash
# 1. Detect patterns
python strat_absortion/plot_deep.py

# 2. Backtest
python strategies/strat_OM_4_absortion/strat_absortion_shape.py

# 3. Visualize trades
python strategies/strat_OM_4_absortion/plot_trades_chart.py

# 4. Summary
python strategies/strat_OM_4_absortion/summary.py

# 5. Analyze exits (optional)
python utils/count_exit_reasons.py
```

---

## Project Structure

```
fabio_valentini/
├── data/
│   ├── time_and_sales_nq.csv (448K ticks)
│   └── time_and_sales_nq_30min.csv (19K ticks)
├── outputs/
│   ├── db_shapes_YYYYMMDD_HHMMSS.csv (pattern signals)
│   └── tracking_record_absortion_shape_all_day.csv (trade results)
├── charts/
│   ├── trades_visualization_absortion_shape_all_day.html
│   ├── summary_report_absortion_shape_all_day.html
│   └── backtest_results_absortion_shape_all_day_*.html
├── strat_absortion/
│   ├── plot_deep.py (Market Profile pattern detection)
│   ├── plot_deep_tick.py (tick-level backup)
│   └── ABSORTION.md (documentation)
├── strategies/
│   ├── path_helper.py (cross-strategy path resolution)
│   ├── strat_OM_4_absortion/
│   │   ├── main_start.py (orchestrator)
│   │   ├── strat_absortion_shape.py (backtest engine)
│   │   ├── plot_trades_chart.py (visualization)
│   │   ├── plot_backtest_results.py (equity charts)
│   │   └── summary.py (statistics)
│   ├── strat_OM_1/ (legacy ATR strategy)
│   ├── strat_OM_2/ (legacy volume strategy)
│   └── strat_OM_3/ (legacy volume strategy v2)
├── utils/
│   ├── count_exit_reasons.py (exit analysis)
│   └── CLEAN_DATA.md
├── stat_quant/ (legacy absorption detection)
├── plot_real_time_streamlit.py (legacy Streamlit app)
├── plot_absortion_chart.py (legacy static chart)
├── plot_footprint_chart.py (volume footprint)
├── plot_time_and_sales.py (time & sales table)
├── config.py (global configuration)
├── CLAUDE.md (comprehensive AI assistant instructions)
└── README.md (this file)
```

---

## Key Improvements vs Legacy Code

### Tick-Driven Architecture
**Before:** Batch-processed signals, allowed overlapping trades
**After:** Sequential tick processing, real-time position tracking

### Position Control
**Before:** 5,367 trades (no limit)
**After:** 589 trades (NUM_MAX_OPEN_CONTRACTS=1)

### Performance
**Before:** Reprocessed all historical data per signal
**After:** Single-pass sequential processing (~1800x faster)

### Visualization
**Before:** Generic markers, no exit coloring
**After:** Color-coded exits (green TARGET, red STOP), dotted lines

### Workflow
**Before:** Manual execution of each script
**After:** One-command execution (main_start.py)

---

## Configuration

### Global Config (`config.py`)

```python
CHART_WIDTH = 1400
CHART_HEIGHT = 800
DATA_DIR = 'data/'
SYMBOL = 'NQ'
```

### Path Helper (`strategies/path_helper.py`)

Cross-strategy path resolution:
```python
from path_helper import get_output_path, get_charts_path

output_file = get_output_path('tracking_record.csv')
chart_file = get_charts_path('trades_chart.html')
```

---

## Troubleshooting

### No patterns detected

**Cause:** Threshold too high or insufficient data

**Fix:** In `strat_absortion/plot_deep.py`, adjust:
```python
CONCENTRATION_THRESHOLD = 0.60  # Lower from 0.70
MIN_SIZE = 15                   # Lower from 20
```

### Too many trades (overlapping positions)

**Cause:** NUM_MAX_OPEN_CONTRACTS not working

**Check:** Verify tick-driven architecture in `strat_absortion_shape.py`:
- Should use `merge` to combine signals + ticks
- Process ticks sequentially, not batch-process signals

### Chart not opening

**Cause:** Browser not found

**Fix:** Manually open HTML from `charts/` folder

### Memory error during backtest

**Cause:** Large dataset (448K ticks)

**Fix:** Use 30-minute subset for testing:
```python
TNS_FILE = DATA_DIR / "time_and_sales_nq_30min.csv"
```

### Streamlit Warning: "missing ScriptRunContext"

**Problem:** Running with `python plot_real_time_streamlit.py`

**Solution:** Always use:
```bash
streamlit run plot_real_time_streamlit.py
```

---

## Performance Benchmarks

### Market Profile Detection (plot_deep.py)
- **Input:** 448,332 ticks
- **Timestamps:** 172,783 (500ms aggregation)
- **Duration:** ~3-4 minutes
- **Patterns:** ~1,000 detected
- **Memory:** ~500MB peak

### Backtest (strat_absortion_shape.py)
- **Input:** 448,332 ticks + 5,367 signals
- **Duration:** ~2-3 minutes
- **Trades:** 589 (with position control)
- **Memory:** ~200MB

### Complete Workflow (main_start.py)
- **Total Duration:** ~6-8 minutes
- **Browser Tabs:** 3 (trades + summary + equity)
- **Files Generated:** 4 (CSV + 3 HTML)

---

## Technical Notes

- **CSV Format:** European (`;` separator, `,` decimal)
- **Timestamps:** Madrid time (CET/CEST)
- **Memory Usage:** ~700MB peak during full workflow
- **Windows Compatibility:** No Unicode in console (ASCII only)
- **NQ Tick Size:** 0.25 points
- **Point Value:** $20 per point

---

## Future Enhancements

### Planned Features
- [ ] Multiple position support (NUM_MAX_OPEN_CONTRACTS > 1)
- [ ] Dynamic TP/SL based on ATR
- [ ] Slippage simulation
- [ ] Commission integration
- [ ] Real-time signal streaming
- [ ] Webhook integration for alerts

### Parameter Optimization
- [ ] Grid search for TP/SL combinations
- [ ] Walk-forward analysis
- [ ] Monte Carlo simulation
- [ ] Out-of-sample testing

---

## License

Private project - Fabio Valentini

---

## Version History

- **Version 2.0** (Current) - Tick-Driven Architecture
  - Market Profile d-Shape & p-Shape detection
  - Tick-driven backtest engine
  - Position control mechanism
  - Complete workflow automation (main_start.py)
  - Updated performance metrics (589 trades vs 5,367)
  - Improved visualization with color-coded exits

- **Version 1.0** (Legacy) - Absorption Detection
  - Statistical z-score absorption detection
  - ATR-based strategies
  - Basic backtest engine

---

*Last updated: 2025-10-24*
