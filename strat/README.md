# Trading Strategy Documentation - `strat/` Folder

## Overview
This folder contains the complete backtesting framework for the absorption-based NQ trading strategy, including strategy execution, performance analysis, and trade visualization.

---

## Files

### 1. `strat_fabio_ATR.py` - Main Strategy Engine
**Purpose:** Execute tick-by-tick backtest using absorption signals with fixed TP/SL levels

**Strategy Logic:**
- **LONG Entry:** When `bid_abs = True` (absorption on BID side)
  - Heavy selling volume detected
  - Price doesn't drop as expected
  - Interpretation: Strong buyers absorbing supply → bullish signal
- **SHORT Entry:** When `ask_abs = True` (absorption on ASK side)
  - Heavy buying volume detected
  - Price doesn't rise as expected
  - Interpretation: Strong sellers absorbing demand → bearish signal

**Risk Management:**
- **Take Profit:** Fixed 2.5 points (configurable via `TP_POINTS`)
- **Stop Loss:** Fixed 2.0 points (configurable via `SL_POINTS`)
- **End-of-Day Close:** All positions closed at 16:00 (configurable via `EOD_TIME`)
- **Position Size:** 1 contract (configurable via `CONTRACTS`)

**Configuration Variables (Lines 22-41):**
```python
SYMBOL = 'NQ'                    # Trading instrument
DATA_FILE = 'data/time_and_sales_absorption_NQ.csv'
OUTPUT_FILE = 'outputs/tracking_record.csv'

ATR_PERIOD = 14                  # ATR calculation (reference only)
TP_POINTS = 2.5                  # Take profit in points
SL_POINTS = 2.0                  # Stop loss in points

TICK_SIZE = 0.25                 # NQ tick size
POINT_VALUE = 20                 # $20 per point
CONTRACTS = 1                    # Contracts per trade

EOD_TIME = time(16, 00)          # End-of-day close time
```

**Execution:**
```bash
python strat/strat_fabio_ATR.py
```

**Output:**
- CSV file: `outputs/tracking_record.csv`
- Console log: Trade count, P&L summary
- Columns in output:
  - `entry_time`, `exit_time`: Timestamps (Madrid time)
  - `side`: LONG / SHORT
  - `entry_price`, `exit_price`: Execution prices
  - `tp_level`, `sl_level`: Target levels set at entry
  - `exit_reason`: TP / SL / EOD
  - `points`: P&L in points
  - `profit_usd`: P&L in dollars ($20 per point)
  - `cumulative_pnl`: Running total P&L

**Process Flow:**
1. Load `time_and_sales_absorption_NQ.csv` (103K records)
2. Calculate ATR(14) for reference
3. Iterate through each tick:
   - Check for absorption signal (bid_abs or ask_abs)
   - Open position if no position active
   - Track TP/SL levels for open positions
   - Close position if TP/SL hit or EOD reached
4. Write all trades to CSV
5. Display summary statistics

**Duration:** ~30-60 seconds for full backtest

---

### 2. `summary.py` - Performance Analysis
**Purpose:** Calculate and display comprehensive backtest statistics

**Metrics Calculated:**
- **Basic Stats:**
  - Total Trades
  - Winning Trades / Losing Trades
  - Win Rate (%)
- **P&L Metrics:**
  - Total P&L (points and USD)
  - Average Win / Average Loss
  - Largest Win / Largest Loss
  - Profit Factor (Gross Profit / Gross Loss)
- **Risk Metrics:**
  - Sharpe Ratio (annualized)
  - Maximum Drawdown (points and USD)
  - Average Trade Duration (minutes)

**Execution:**
```bash
python strat/summary.py
```

**Input:** `outputs/tracking_record.csv` (generated by `strat_fabio_ATR.py`)

**Output:** Console table with formatted statistics

**Example Output:**
```
==================================================
PERFORMANCE SUMMARY
==================================================

Basic Statistics:
  Total Trades:        2,755
  Winning Trades:      1,234 (44.79%)
  Losing Trades:       1,521 (55.21%)

P&L Metrics:
  Total P&L:           +123.50 points ($2,470.00)
  Average Win:         +2.50 points ($50.00)
  Average Loss:        -2.00 points ($-40.00)
  Largest Win:         +2.50 points ($50.00)
  Largest Loss:        -2.00 points ($-40.00)
  Profit Factor:       1.25

Risk Metrics:
  Sharpe Ratio:        1.45
  Max Drawdown:        -45.75 points ($-915.00)
  Avg Trade Duration:  12.5 minutes
```

**Requirements:**
- Must run `strat_fabio_ATR.py` first to generate trade log
- Requires `tracking_record.csv` with complete trade data

---

### 3. `plot_trades_chart.py` - Trade Visualization
**Purpose:** Overlay trade entries/exits on price chart with P&L visualization

**Features:**
- **Main Chart (Top):**
  - Price line (blue)
  - BID trades: Small red dots (opacity 0.3)
  - ASK trades: Small green dots (opacity 0.3)
  - LONG entries: Large green circles
  - SHORT entries: Large red circles
  - Profitable exits: Green triangles (up)
  - Losing exits: Red triangles (down)
  - P&L annotations: USD value next to each exit marker
- **P&L Chart (Bottom):**
  - Cumulative P&L line (green if positive, red if negative)
  - Zero line reference

**Configuration (Lines 18-20):**
```python
DEFAULT_START_INDEX = 0      # First trade to display
DEFAULT_END_INDEX = 500      # Last trade to display (500 trades)
```

**Customization:**
To view different trade ranges, edit the script:
```python
# Example: View trades 100-200
DEFAULT_START_INDEX = 100
DEFAULT_END_INDEX = 200

# Example: View all trades (warning: may be slow if >5000 trades)
DEFAULT_START_INDEX = 0
DEFAULT_END_INDEX = 99999
```

**Execution:**
```bash
python strat/plot_trades_chart.py
```

**Input:**
- `outputs/tracking_record.csv` (trade log)
- `data/time_and_sales_absorption_NQ.csv` (price data)

**Output:**
- HTML chart: `charts/trades_visualization.html`
- Browser opens automatically

**Performance:**
- 500 trades: Fast (~2 seconds)
- 2000+ trades: Slower (~10 seconds)
- 5000+ trades: May lag in browser

**Interactive Features:**
- Hover over markers: View trade details
- Zoom: Click and drag
- Pan: Shift + drag
- Reset: Double-click

---

### 4. `plot_backtest_results.py` - Alternative Plotter
**Purpose:** Legacy visualization script (alternative to `plot_trades_chart.py`)

**Differences:**
- Simpler layout
- Fewer customization options
- Faster rendering for large datasets

**Execution:**
```bash
python strat/plot_backtest_results.py
```

**When to Use:**
- Quick preliminary visualization
- Very large trade counts (5000+)
- Troubleshooting main plotter

---

## Workflow: Complete Backtest Process

### Step-by-Step Guide

#### 1. Generate Absorption Signals (If Not Already Done)
```bash
python stat_quant/find_absortion_vol_efford.py
```
- Input: `data/time_and_sales_nq.csv` (raw tick data)
- Output: `data/time_and_sales_absorption_NQ.csv` (with bid_abs, ask_abs columns)
- Duration: ~2-3 minutes

#### 2. Run Strategy Backtest
```bash
python strat/strat_fabio_ATR.py
```
- Processes 103K ticks
- Generates trade log
- Duration: ~30-60 seconds

#### 3. Analyze Performance
```bash
python strat/summary.py
```
- Displays all key metrics
- Instant output

#### 4. Visualize Trades
```bash
python strat/plot_trades_chart.py
```
- Opens interactive chart in browser
- Default: First 500 trades
- Duration: ~2-5 seconds

---

## Parameter Tuning Guide

### Absorption Detection Parameters
**File:** `stat_quant/find_absortion_vol_efford.py`

**Conservative (Fewer, Higher Quality Signals):**
```python
ANOMALY_THRESHOLD = 2.0      # Increase from 1.5
PRICE_MOVE_TICKS = 3         # Increase from 2
WINDOW_MINUTES = 10          # Increase from 5
```
- **Effect:** Fewer absorptions detected, stronger signals
- **Trade Count:** Decreases
- **Win Rate:** May increase

**Aggressive (More Signals):**
```python
ANOMALY_THRESHOLD = 1.0      # Decrease from 1.5
PRICE_MOVE_TICKS = 1         # Decrease from 2
WINDOW_MINUTES = 3           # Decrease from 5
```
- **Effect:** More absorptions detected, weaker signals
- **Trade Count:** Increases
- **Win Rate:** May decrease

### Risk Management Parameters
**File:** `strat/strat_fabio_ATR.py`

**Tighter Risk (Higher Win Rate, Lower R:R):**
```python
TP_POINTS = 2.0              # Smaller target
SL_POINTS = 1.0              # Tighter stop
# Result: 2:1 reward/risk ratio
```

**Wider Risk (Lower Win Rate, Higher R:R):**
```python
TP_POINTS = 4.0              # Larger target
SL_POINTS = 2.0              # Wider stop
# Result: 2:1 reward/risk ratio maintained
```

**Asymmetric Risk:**
```python
TP_POINTS = 5.0              # Much larger target
SL_POINTS = 2.0              # Smaller stop
# Result: 2.5:1 reward/risk ratio
```

### Testing Different Timeframes
**EOD Close Time:**
```python
# Earlier close (avoid late-day volatility)
EOD_TIME = time(15, 30)

# Later close (capture full session)
EOD_TIME = time(16, 30)
```

---

## Troubleshooting

### Error: `tracking_record.csv` not found
**Cause:** Strategy backtest not run yet
**Fix:** Run `python strat/strat_fabio_ATR.py` first

### Error: `time_and_sales_absorption_NQ.csv` not found
**Cause:** Absorption detection not run
**Fix:** Run `python stat_quant/find_absortion_vol_efford.py` first

### Chart not opening in browser
**Cause:** Browser path issue
**Fix:** Manually open `charts/trades_visualization.html`

### Very low win rate (<30%)
**Possible Causes:**
- Absorption threshold too low (too many weak signals)
- TP too wide / SL too tight
- Market conditions not suitable

**Recommended Actions:**
1. Check summary statistics for trade distribution
2. Visualize trades to identify patterns
3. Increase `ANOMALY_THRESHOLD` to 2.0
4. Adjust TP/SL ratio

### Strategy runs but no trades generated
**Possible Causes:**
- No absorption signals in data
- Absorption columns missing from CSV

**Recommended Actions:**
1. Check if `bid_abs` and `ask_abs` columns exist in CSV
2. Verify absorption detection ran successfully
3. Lower `ANOMALY_THRESHOLD` in detection script

---

## Future Enhancements

### Planned Features
- Dynamic position sizing based on ATR
- Multiple TP levels (scale out)
- Trailing stop loss
- Time-based filters (avoid pre-market, news events)
- Multi-symbol support (ES, RTY, YM)
- Walk-forward optimization
- Monte Carlo simulation

### Advanced Analysis
- Trade distribution by time of day
- Win rate by hour / day of week
- Consecutive win/loss streaks
- MAE/MFE analysis (Maximum Adverse/Favorable Excursion)
- Trade duration distribution

---

## Important Notes

### Assumptions & Limitations
- **No Slippage:** Assumes execution at exact signal price
- **No Commission:** P&L calculated without trading costs
- **Perfect Data:** Assumes no missing ticks or data gaps
- **Single Contract:** No position sizing or scaling
- **No Correlation:** Treats each trade independently
- **Historical Simulation:** Past performance ≠ future results

### NQ-Specific Details
- **Tick Size:** 0.25 points
- **Point Value:** $20 per point
- **Minimum Move:** $5 per contract (0.25 × $20)
- **Example:** 2.5 point move = 10 ticks = $50

### Data Requirements
- European CSV format (`;` separator, `,` decimal)
- Timestamp column in Madrid time (CET/CEST)
- Required columns: Timestamp, Precio, Volumen, Lado, Bid, Ask, bid_abs, ask_abs

---

## Quick Reference

### Commands
```bash
# Full workflow
python stat_quant/find_absortion_vol_efford.py  # Step 1: Detect absorptions
python strat/strat_fabio_ATR.py                 # Step 2: Run backtest
python strat/summary.py                         # Step 3: View stats
python strat/plot_trades_chart.py               # Step 4: Visualize
```

### File Paths
```
Inputs:
  data/time_and_sales_nq.csv                    # Raw tick data
  data/time_and_sales_absorption_NQ.csv         # With absorption signals

Outputs:
  outputs/tracking_record.csv                   # Trade log
  charts/trades_visualization.html              # Interactive chart
```

### Key Parameters
```python
# Detection (find_absortion_vol_efford.py)
ANOMALY_THRESHOLD = 1.5                         # Z-score threshold
PRICE_MOVE_TICKS = 2                            # Expected price move

# Strategy (strat_fabio_ATR.py)
TP_POINTS = 2.5                                 # Take profit
SL_POINTS = 2.0                                 # Stop loss

# Visualization (plot_trades_chart.py)
DEFAULT_START_INDEX = 0                         # First trade
DEFAULT_END_INDEX = 500                         # Last trade
```
