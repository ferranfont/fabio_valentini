# CLAUDE.md - Fabio Valentini Project

## Project Overview
Advanced NQ (Nasdaq-100 E-mini) futures order flow analysis and trading toolkit featuring:
- **Market Profile Analysis**: d-Shape & p-Shape absorption pattern detection
- **Tick-Driven Backtesting**: Real-time position tracking with configurable risk management
- **Interactive Visualizations**: Plotly-based charts with trade overlays
- **Statistical Analysis**: Comprehensive performance metrics and reporting
- **Automated Workflow**: One-command execution of complete strategy pipeline

## Quick Start

### Run Complete Strategy (Recommended)
```bash
cd strategies/strat_OM_4_absortion
python main_start.py
```
This executes the entire workflow:
1. Backtest with tick-driven engine
2. Generate trade visualization
3. Create performance summary and charts

### Individual Components
```bash
# Step 1: Detect Market Profile patterns
python strat_absortion/plot_deep.py

# Step 2: Run backtest
python strategies/strat_OM_4_absortion/strat_absortion_shape.py

# Step 3: Visualize trades
python strategies/strat_OM_4_absortion/plot_trades_chart.py

# Step 4: Generate summary
python strategies/strat_OM_4_absortion/summary.py
```

## Data Sources

### Primary Data Files
Located in `data/` folder:

#### NQ Futures (Primary)
- **time_and_sales_nq.csv** - 448,332 tick records
  - Period: 2 days (Oct 9-10, 2025)
  - Columns: Timestamp, Precio, Volumen, Lado, Bid, Ask
  - Format: European (`;` separator, `,` decimal)

- **time_and_sales_nq_30min.csv** - 19,794 records
  - Subset for quick testing (30-minute window)

#### Signal Files
Located in `outputs/` folder:
- **db_shapes_YYYYMMDD_HHMMSS.csv** - Market Profile pattern detections
  - Columns: timestamp, shape, close_price, bid_ask_ratio, num_price_levels, etc.
  - Generated by `strat_absortion/plot_deep.py`

### Data Format
```csv
Timestamp;Precio;Volumen;Lado;Bid;Ask
2025-10-09 06:00:20.592;25327,5;1;ASK;25327,25;25327,5
```
**Important**: Always use European CSV format (`sep=';', decimal=','`)

---

## Market Profile Analysis (`strat_absortion/`)

### Pattern Detection: plot_deep.py

**Purpose**: Detect d-Shape and p-Shape absorption patterns using rolling Market Profile

**Algorithm**:
1. **500ms timestamp aggregation** (172,783 frames for 2-day dataset)
2. **Rolling Market Profile** (60-second window)
   - Aggregates volume by price level
   - Identifies POC (Point of Control)
   - Calculates volume distribution
3. **Pattern Detection Criteria**:
   - **d-Shape** (BID absorption → expect bounce):
     - 70%+ volume concentration
     - Skewed toward lower prices
     - 10+ price levels, size 20+ contracts
   - **p-Shape** (ASK absorption → expect drop):
     - 70%+ volume concentration
     - Skewed toward upper prices
     - 10+ price levels, size 20+ contracts

**Configuration** (Lines 13-25):
```python
PROFILE_FREQUENCY = 60          # Window size in seconds
CONCENTRATION_THRESHOLD = 0.70  # 70% volume concentration
MIN_LEVELS = 10                 # Minimum price levels
MIN_SIZE = 20                   # Minimum total volume
```

**Execution**:
```bash
python strat_absortion/plot_deep.py
```

**Performance**:
- Processes 172,783 timestamps in ~3-4 minutes
- Detects ~1,000 patterns (422 d-shapes, 582 p-shapes)

**Output**:
- CSV: `outputs/db_shapes_{timestamp}.csv`
- Interactive chart with matplotlib (mplcursors tooltips)

**Backups**:
- `plot_deep_tick.py` - Tick-level granularity (maximum precision, slow UI)
- `plot_deep.py` - 500ms aggregation (balanced precision/performance)

---

## Trading Strategy Module (`strategies/strat_OM_4_absortion/`)

### 1. Tick-Driven Backtest Engine: strat_absortion_shape.py

**Purpose**: Execute backtest with real-time position tracking and risk management

**Key Features**:
- **Tick-by-tick processing**: 448,332 ticks processed sequentially
- **Position limit control**: `NUM_MAX_OPEN_CONTRACTS` prevents overlapping trades
- **Merge-based architecture**: Accurate execution timing

**Strategy Logic**:
- **LONG Entry**: d_shape detected (BID absorption)
- **SHORT Entry**: p_shape detected (ASK absorption)
- **Take Profit**: 4.0 points
- **Stop Loss**: 3.0 points
- **Max Positions**: 1 (configurable)

**Configuration** (Lines 35-41):
```python
SYMBOL = "NQ"
TP_POINTS = 4.0
SL_POINTS = 3.0
POINT_VALUE = 20.0
CONTRACTS = 1
NUM_MAX_OPEN_CONTRACTS = 1  # Prevents overlapping trades
```

**Execution**:
```bash
python strategies/strat_OM_4_absortion/strat_absortion_shape.py
```

**Output**: `outputs/tracking_record_absortion_shape_all_day.csv`

**Performance** (with NUM_MAX_OPEN_CONTRACTS=1):
- Trades: 589 (down from 5,367 without position control)
- Win Rate: 50.9%
- Total P&L: $6,660
- Max DD: -$720
- Processing time: ~2-3 minutes

---

### 2. Trade Visualization: plot_trades_chart.py

**Purpose**: Interactive Plotly chart with trade overlays

**Visual Elements**:
- **Entry markers**:
  - Triangle-up (green) = LONG
  - Triangle-down (red) = SHORT
- **Exit markers**:
  - Square-open (green) = TARGET exit
  - Square-open (red) = STOP exit
- **Connection lines**: Dotted, color-coded (green=TARGET, red=STOP)
- **Dual panels**: Price chart + P&L cumulative

**Configuration** (Lines 57-62):
```python
USE_INDEX_RANGE = False  # False = show ALL trades
START_INDEX = 0
END_INDEX = 50           # Only used if USE_INDEX_RANGE = True
```

**Modes**:
1. **Full Day** (default): Shows all 589 trades
2. **Index Range**: Filter by trade indices (0-50, etc.)

**Execution**:
```bash
python strategies/strat_OM_4_absortion/plot_trades_chart.py
```

**Output**: `charts/trades_visualization_absortion_shape_all_day.html`

---

### 3. Performance Summary: summary.py

**Purpose**: Comprehensive HTML report with statistics

**Metrics**:
- Win/Loss breakdown
- Profit Factor, Sharpe Ratio
- Max Drawdown, Recovery Factor
- Exit reason analysis (TARGET/STOP)
- Signal breakdown (d_shape vs p_shape)

**Table Layout**:
- Compact design (700px width)
- Color-coded values (green=positive, red=negative)
- Reduced font sizes and spacing

**Execution**:
```bash
python strategies/strat_OM_4_absortion/summary.py
```

**Output**:
- `charts/summary_report_absortion_shape_all_day.html`
- Calls `plot_backtest_results.py` internally for equity charts

---

### 4. Equity Charts: plot_backtest_results.py

**Purpose**: Visualize equity curve, drawdown, and distributions

**Charts**:
- Cumulative equity line
- Drawdown overlay
- Profit distribution histograms

**Execution**:
```bash
python strategies/strat_OM_4_absortion/plot_backtest_results.py
```

**Output**: `charts/backtest_results_absortion_shape_all_day_*.html`

---

### 5. Main Orchestrator: main_start.py

**Purpose**: Automated workflow execution with centralized configuration

**Workflow**:
```
PASO 1: EJECUTANDO BACKTEST
  ├─ Load signals and tick data
  ├─ Run tick-driven backtest
  └─ Generate tracking_record CSV

PASO 2: GENERANDO VISUALIZACIÓN DE TRADES
  ├─ Load trades and base data
  ├─ Create interactive Plotly chart
  └─ Open in browser

PASO 3: GENERANDO RESUMEN ESTADÍSTICO Y GRÁFICOS
  ├─ Calculate performance metrics
  ├─ Generate HTML summary table
  ├─ Create equity/drawdown charts
  └─ Open all reports in browser
```

**Centralized Parameters** (Lines 24-56):
```python
# Files
TNS_FILE = "time_and_sales_nq.csv"
SIGNALS_FILE = "db_shapes_20251024_003251.csv"

# Strategy
TP_POINTS = 4.0
SL_POINTS = 3.0
NUM_MAX_OPEN_CONTRACTS = 1

# Visualization
USE_INDEX_RANGE = False  # Show all trades
```

**Execution**:
```bash
cd strategies/strat_OM_4_absortion
python main_start.py
```

**Outputs** (3 browser tabs):
1. Trades visualization
2. Summary statistics
3. Equity charts

---

## Utilities (`utils/`)

### count_exit_reasons.py
Analyze exit types from tracking_record CSV:
```bash
python utils/count_exit_reasons.py
```

**Output**:
```
TARGET exits: 257 (44.08%) | Profit: $20,560
STOP exits: 326 (55.92%) | Profit: -$19,560
```

**Breakdown by signal**:
- d_shape (LONG): 241 trades → +$1,780
- p_shape (SHORT): 342 trades → -$780

---

## Configuration Files

### config.py
Central configuration:
```python
CHART_WIDTH = 1400
CHART_HEIGHT = 800
DATA_DIR = 'data/'
SYMBOL = 'NQ'
```

### path_helper.py
Cross-strategy path resolution:
```python
def get_output_path(filename):
    return PROJECT_ROOT / "outputs" / filename

def get_charts_path(filename):
    return PROJECT_ROOT / "charts" / filename
```

---

## Important Notes

### CSV Format
**Always use European format**:
- Separator: `;` (semicolon)
- Decimal: `,` (comma)
- Reading: `pd.read_csv(path, sep=';', decimal=',')`
- Writing: `df.to_csv(path, sep=';', decimal=',')`

### Timestamps
- Madrid time (CET/CEST)
- Format: `YYYY-MM-DD HH:MM:SS.microseconds`

### Memory Usage
- Market Profile detection: ~500MB peak
- Backtest processing: ~200MB
- Full workflow: ~700MB total

### Windows Compatibility
- No Unicode characters in console output
- Use ASCII only (`[OK]`, `[ERROR]` instead of ✓, ✗)
- Charts open in default browser automatically

---

## Workflow: Complete Strategy Pipeline

### Standard Workflow (Recommended)
```bash
# 1. Detect patterns (run once when data changes)
python strat_absortion/plot_deep.py

# 2. Run complete strategy pipeline
cd strategies/strat_OM_4_absortion
python main_start.py
```

### Manual Step-by-Step
```bash
# 1. Detect patterns
python strat_absortion/plot_deep.py

# 2. Backtest
python strategies/strat_OM_4_absortion/strat_absortion_shape.py

# 3. Visualize trades
python strategies/strat_OM_4_absortion/plot_trades_chart.py

# 4. Summary
python strategies/strat_OM_4_absortion/summary.py

# 5. Analyze exits
python utils/count_exit_reasons.py
```

---

## Troubleshooting

### No patterns detected
**Cause**: Threshold too high or insufficient data
**Fix**: In `plot_deep.py`, adjust:
```python
CONCENTRATION_THRESHOLD = 0.60  # Lower from 0.70
MIN_SIZE = 15                   # Lower from 20
```

### Too many trades (overlapping positions)
**Cause**: `NUM_MAX_OPEN_CONTRACTS` not working
**Check**: Verify tick-driven architecture in `strat_absortion_shape.py`
- Should use `merge` to combine signals + ticks
- Process ticks sequentially, not batch-process signals

### Chart not opening
**Cause**: Browser not found
**Fix**: Manually open HTML from `charts/` folder

### Memory error during backtest
**Cause**: Large dataset (448K ticks)
**Fix**: Use 30-minute subset for testing:
```python
TNS_FILE = DATA_DIR / "time_and_sales_nq_30min.csv"
```

---

## Performance Benchmarks

### Market Profile Detection (plot_deep.py)
- **Input**: 448,332 ticks
- **Timestamps**: 172,783 (500ms aggregation)
- **Duration**: ~3-4 minutes
- **Patterns**: ~1,000 detected
- **Memory**: ~500MB peak

### Backtest (strat_absortion_shape.py)
- **Input**: 448,332 ticks + 5,367 signals
- **Duration**: ~2-3 minutes
- **Trades**: 589 (with position control)
- **Memory**: ~200MB

### Complete Workflow (main_start.py)
- **Total Duration**: ~6-8 minutes
- **Browser Tabs**: 3 (trades + summary + equity)
- **Files Generated**: 4 (CSV + 3 HTML)

---

## Development Guidelines

### When to Re-run Pattern Detection
- New data available
- Parameter changes (CONCENTRATION_THRESHOLD, MIN_SIZE)
- Different timeframe (500ms vs 1s vs tick-level)

### When to Re-run Backtest
- New signals CSV generated
- Parameter changes (TP_POINTS, SL_POINTS, NUM_MAX_OPEN_CONTRACTS)
- Different data file (full day vs 30min)

### Code Style
- European CSV format mandatory
- No Unicode in console (Windows)
- Use path_helper for cross-strategy paths
- Always include timestamps in output files
- Auto-open HTML files in browser

### Git Workflow
```bash
# Check status
git status

# Add strategy files only (not outputs/charts)
git add strategies/ utils/ strat_absortion/

# Commit with descriptive message
git commit -m "Update strategy with position control"

# Push to remote
git push origin main
```

---

## File Structure
```
fabio_valentini/
├── data/
│   ├── time_and_sales_nq.csv (448K ticks)
│   └── time_and_sales_nq_30min.csv (19K ticks)
├── outputs/
│   ├── db_shapes_YYYYMMDD_HHMMSS.csv
│   └── tracking_record_absortion_shape_all_day.csv
├── charts/
│   ├── trades_visualization_absortion_shape_all_day.html
│   ├── summary_report_absortion_shape_all_day.html
│   └── backtest_results_absortion_shape_all_day_*.html
├── strat_absortion/
│   ├── plot_deep.py (pattern detection)
│   └── plot_deep_tick.py (tick-level backup)
├── strategies/strat_OM_4_absortion/
│   ├── main_start.py (orchestrator)
│   ├── strat_absortion_shape.py (backtest)
│   ├── plot_trades_chart.py (visualization)
│   ├── plot_backtest_results.py (equity charts)
│   └── summary.py (statistics)
└── utils/
    └── count_exit_reasons.py (analysis)
```

---

## Key Improvements vs Legacy Code

### Tick-Driven Architecture
**Before**: Batch-processed signals, allowed overlapping trades
**After**: Sequential tick processing, real-time position tracking

### Position Control
**Before**: 5,367 trades (no limit)
**After**: 589 trades (NUM_MAX_OPEN_CONTRACTS=1)

### Performance
**Before**: Reprocessed all historical data per signal
**After**: Single-pass sequential processing (~1800x faster)

### Visualization
**Before**: Generic markers, no exit coloring
**After**: Color-coded exits (green TARGET, red STOP), dotted lines

### Workflow
**Before**: Manual execution of each script
**After**: One-command execution (`main_start.py`)

---

## Future Enhancements

### Planned Features
- [ ] Multiple position support (NUM_MAX_OPEN_CONTRACTS > 1)
- [ ] Dynamic TP/SL based on ATR
- [ ] Slippage simulation
- [ ] Commission integration
- [ ] Real-time signal streaming
- [ ] Webhook integration for alerts

### Parameter Optimization
- [ ] Grid search for TP/SL combinations
- [ ] Walk-forward analysis
- [ ] Monte Carlo simulation
- [ ] Out-of-sample testing

---

*Last updated: 2025-10-24*
*Version: 2.0 (Tick-Driven Architecture)*
